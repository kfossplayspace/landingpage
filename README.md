Need to make the code more structured for troubleshooting.
I was borrowing code from multiple sources and got lost in where the pieces belonged.
